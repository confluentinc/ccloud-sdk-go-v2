version: v1.0
name: Find changed folder and push to the public SDK repo
agent:
  machine:
    type: s1-prod-ubuntu20-04-amd64-1

blocks:
  - name: Checkout, Copy, Modify, and Push
    task:
      jobs:
        - name: Sync Changes
          commands:
            - checkout
            - |
              # Checkout the public repository
              git clone https://github.com/confluentinc/ccloud-sdk-go-v2.git public-repo
            - |
              # Checkout the internal repository
              git clone https://github.com/confluentinc/ccloud-sdk-go-v2-internal.git internal-repo
            - |
              # Define the package names
              INTERNAL_PATH="github.com/confluentinc/ccloud-sdk-go-v2-internal"
              PUBLIC_PATH="github.com/confluentinc/ccloud-sdk-go-v2"
              # Find the changed folders in the internal repo
              cd internal-repo
              CHANGED_FOLDERS=$(git diff --name-only origin/master~2 origin/master~ | grep '/' | cut -d'/' -f1 | sort | uniq)
              echo "Changed folder(s): $(CHANGED_FOLDERS)"
              cd ..
              # Copy changed folders from internal repo to public repo
              for folder in $CHANGED_FOLDERS; do
                cp -r internal-repo/$folder public-repo
              done
            - |
              # Modify text in the copied folders in the public repo
              cd public-repo
              pwd
              for folder in $CHANGED_FOLDERS; do
                find $folder -type f -name "go.mod" -exec sed -i '' 's|INTERNAL_PATH|PUBLIC_PATH|g' {} \;
              done
              cd ..
            - |
              # Stage and commit changes in the public repo
              cd public-repo
              git checkout -b sync-changes || echo "Branch sync-changes already exists, continuing..."
              git add .
              git commit -m "Sync changes from internal repo and modify text" || echo "No changes to commit"
            - |
              # Force push the changes to a new branch for PR review
              git push -uf origin sync-changes
